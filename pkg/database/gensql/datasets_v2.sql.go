// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: datasets_v2.sql

package gensql

import (
	"context"
	"database/sql"
	"time"

	"github.com/google/uuid"
	"github.com/lib/pq"
	"github.com/sqlc-dev/pqtype"
)

const getAllDatasetsMinimal = `-- name: GetAllDatasetsMinimal :many
SELECT ds.id, ds.created, name, project_id, dataset, table_name 
FROM datasets ds 
JOIN datasource_bigquery dsb 
ON ds.id = dsb.dataset_id
`

type GetAllDatasetsMinimalRow struct {
	ID        uuid.UUID
	Created   time.Time
	Name      string
	ProjectID string
	Dataset   string
	TableName string
}

func (q *Queries) GetAllDatasetsMinimal(ctx context.Context) ([]GetAllDatasetsMinimalRow, error) {
	rows, err := q.db.QueryContext(ctx, getAllDatasetsMinimal)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []GetAllDatasetsMinimalRow{}
	for rows.Next() {
		var i GetAllDatasetsMinimalRow
		if err := rows.Scan(
			&i.ID,
			&i.Created,
			&i.Name,
			&i.ProjectID,
			&i.Dataset,
			&i.TableName,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getDatasetComplete = `-- name: GetDatasetComplete :many
SELECT
  dp_group, ds_id, ds_name, ds_description, ds_created, ds_last_modified, ds_slug, pii, ds_keywords, ds_repo, ds_target_user, ds_anonymisation_description, bq_id, bq_created, bq_last_modified, bq_expires, bq_description, bq_missing_since, pii_tags, bq_project, bq_dataset, bq_table_name, bq_table_type, pseudo_columns, bq_schema, ds_dp_id, omb_database_id, rmb_database_id
FROM
  dataset_view
WHERE
  ds_id = $1
`

func (q *Queries) GetDatasetComplete(ctx context.Context, id uuid.UUID) ([]DatasetView, error) {
	rows, err := q.db.QueryContext(ctx, getDatasetComplete, id)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []DatasetView{}
	for rows.Next() {
		var i DatasetView
		if err := rows.Scan(
			&i.DpGroup,
			&i.DsID,
			&i.DsName,
			&i.DsDescription,
			&i.DsCreated,
			&i.DsLastModified,
			&i.DsSlug,
			&i.Pii,
			pq.Array(&i.DsKeywords),
			&i.DsRepo,
			&i.DsTargetUser,
			&i.DsAnonymisationDescription,
			&i.BqID,
			&i.BqCreated,
			&i.BqLastModified,
			&i.BqExpires,
			&i.BqDescription,
			&i.BqMissingSince,
			&i.PiiTags,
			&i.BqProject,
			&i.BqDataset,
			&i.BqTableName,
			&i.BqTableType,
			pq.Array(&i.PseudoColumns),
			&i.BqSchema,
			&i.DsDpID,
			&i.OmbDatabaseID,
			&i.RmbDatabaseID,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getDatasetCompleteWithAccess = `-- name: GetDatasetCompleteWithAccess :many
SELECT
  dp_group, ds_id, ds_name, ds_description, ds_created, ds_last_modified, ds_slug, pii, ds_keywords, ds_repo, ds_target_user, ds_anonymisation_description, bq_id, bq_created, bq_last_modified, bq_expires, bq_description, bq_missing_since, pii_tags, bq_project, bq_dataset, bq_table_name, bq_table_type, pseudo_columns, bq_schema, ds_dp_id, omb_database_id, rmb_database_id, access_id, access_subject, access_owner, access_granter, access_expires, access_created, access_revoked, access_dataset_id, access_request_id, access_platform, access_request_owner, access_request_subject, access_request_last_modified, access_request_created, access_request_expires, access_request_status, access_request_closed, access_request_granter, access_request_reason, polly_id, polly_name, polly_url, polly_external_id
FROM
  dataset_view dv
LEFT JOIN dataset_access_view da ON da.access_dataset_id = dv.ds_id 
    AND (
        dp_group = ANY($1::TEXT[])
        OR (
            SPLIT_PART(da.access_subject, ':', 2) = ANY($1::TEXT[])
            AND da.access_revoked IS NULL
        )
    )
WHERE ds_id = $2
`

type GetDatasetCompleteWithAccessParams struct {
	Groups []string
	ID     uuid.UUID
}

type GetDatasetCompleteWithAccessRow struct {
	DpGroup                    sql.NullString
	DsID                       uuid.UUID
	DsName                     string
	DsDescription              sql.NullString
	DsCreated                  time.Time
	DsLastModified             time.Time
	DsSlug                     string
	Pii                        PiiLevel
	DsKeywords                 []string
	DsRepo                     sql.NullString
	DsTargetUser               sql.NullString
	DsAnonymisationDescription sql.NullString
	BqID                       uuid.UUID
	BqCreated                  time.Time
	BqLastModified             time.Time
	BqExpires                  sql.NullTime
	BqDescription              sql.NullString
	BqMissingSince             sql.NullTime
	PiiTags                    pqtype.NullRawMessage
	BqProject                  string
	BqDataset                  string
	BqTableName                string
	BqTableType                string
	PseudoColumns              []string
	BqSchema                   pqtype.NullRawMessage
	DsDpID                     uuid.UUID
	OmbDatabaseID              sql.NullInt32
	RmbDatabaseID              sql.NullInt32
	AccessID                   uuid.NullUUID
	AccessSubject              sql.NullString
	AccessOwner                sql.NullString
	AccessGranter              sql.NullString
	AccessExpires              sql.NullTime
	AccessCreated              sql.NullTime
	AccessRevoked              sql.NullTime
	AccessDatasetID            uuid.NullUUID
	AccessRequestID            uuid.NullUUID
	AccessPlatform             sql.NullString
	AccessRequestOwner         sql.NullString
	AccessRequestSubject       sql.NullString
	AccessRequestLastModified  sql.NullTime
	AccessRequestCreated       sql.NullTime
	AccessRequestExpires       sql.NullTime
	AccessRequestStatus        NullAccessRequestStatusType
	AccessRequestClosed        sql.NullTime
	AccessRequestGranter       sql.NullString
	AccessRequestReason        sql.NullString
	PollyID                    uuid.NullUUID
	PollyName                  sql.NullString
	PollyUrl                   sql.NullString
	PollyExternalID            sql.NullString
}

func (q *Queries) GetDatasetCompleteWithAccess(ctx context.Context, arg GetDatasetCompleteWithAccessParams) ([]GetDatasetCompleteWithAccessRow, error) {
	rows, err := q.db.QueryContext(ctx, getDatasetCompleteWithAccess, pq.Array(arg.Groups), arg.ID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []GetDatasetCompleteWithAccessRow{}
	for rows.Next() {
		var i GetDatasetCompleteWithAccessRow
		if err := rows.Scan(
			&i.DpGroup,
			&i.DsID,
			&i.DsName,
			&i.DsDescription,
			&i.DsCreated,
			&i.DsLastModified,
			&i.DsSlug,
			&i.Pii,
			pq.Array(&i.DsKeywords),
			&i.DsRepo,
			&i.DsTargetUser,
			&i.DsAnonymisationDescription,
			&i.BqID,
			&i.BqCreated,
			&i.BqLastModified,
			&i.BqExpires,
			&i.BqDescription,
			&i.BqMissingSince,
			&i.PiiTags,
			&i.BqProject,
			&i.BqDataset,
			&i.BqTableName,
			&i.BqTableType,
			pq.Array(&i.PseudoColumns),
			&i.BqSchema,
			&i.DsDpID,
			&i.OmbDatabaseID,
			&i.RmbDatabaseID,
			&i.AccessID,
			&i.AccessSubject,
			&i.AccessOwner,
			&i.AccessGranter,
			&i.AccessExpires,
			&i.AccessCreated,
			&i.AccessRevoked,
			&i.AccessDatasetID,
			&i.AccessRequestID,
			&i.AccessPlatform,
			&i.AccessRequestOwner,
			&i.AccessRequestSubject,
			&i.AccessRequestLastModified,
			&i.AccessRequestCreated,
			&i.AccessRequestExpires,
			&i.AccessRequestStatus,
			&i.AccessRequestClosed,
			&i.AccessRequestGranter,
			&i.AccessRequestReason,
			&i.PollyID,
			&i.PollyName,
			&i.PollyUrl,
			&i.PollyExternalID,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}
